---
alwaysApply: true
---

# Clean Architecture Rules - Vita Product Boilerplate

This workspace follows Clean Architecture with SOLID principles and Apollo Client.

## Layer Structure

```
apps/web/src/
├── domain/              # Entities and repository interfaces
├── application/         # Use cases and Apollo Client hooks
├── infrastructure/      # Implementations (Apollo Client, repositories)
└── presentation/        # React components
```

## Rules by Layer

### Domain Layer (`src/domain`)

- ✅ Define TypeScript interfaces for entities
- ✅ Declare repository interfaces (abstract contracts)
- ❌ FORBIDDEN: Implementations, frameworks, Apollo Client, business logic

### Application Layer (`src/application`)

#### Use Cases (`use-cases/`)

- ✅ Implement use case interfaces
- ✅ Orchestrate repository calls
- ✅ Transform data between layers when necessary
- ❌ FORBIDDEN: React components, Apollo hooks directly

#### Hooks (`hooks/`)

- ✅ Use `useQuery` and `useMutation` from `@apollo/client/react`
- ✅ Define GraphQL queries using `gql`
- ✅ Return standard format: `{ data, isLoading, isError, error, refetch }`
- ✅ Normalize Apollo data to domain entities
- ❌ FORBIDDEN: Complex business logic (should go to use cases)

### Infrastructure Layer (`src/infrastructure`)

- ✅ Implement repository interfaces
- ✅ Configure Apollo Client
- ✅ Use Apollo Client to make queries/mutations
- ❌ FORBIDDEN: React components, Apollo hooks directly, business logic, use case dependencies

### Presentation Layer (`src/presentation`)

- ✅ React components
- ✅ Use hooks from the application layer
- ❌ FORBIDDEN: Call repositories or use cases directly, define GraphQL queries

## Dependency Flow

```
Presentation → Application → Domain ← Infrastructure
```

- Domain does not import from any other layer
- Application imports only from Domain
- Infrastructure imports only from Domain
- Presentation imports only from Application and Domain (for types)

## Conventions

### Naming

- Entities: PascalCase singular (`Task`, `User`)
- Repository Interfaces: `{Entity}RepositoryInterface`
- Implementations: `{Entity}RepositoryImpl`
- Use Cases: Infinitive verbs (`GetTasks`, `CreateTask`)
- Use Case Interfaces: `I` prefix (`IGetTasks`)
- Hooks: `use{Action}{Entity}` (`useGetTasks`)
- GraphQL Queries: `GET_{ENTITY}` or `{ACTION}_{ENTITY}` (`GET_TASKS`, `CREATE_TASK`)

### GraphQL Query Structure

Centralize queries in hook files or in `src/application/graphql/queries.ts`:

```typescript
import { gql } from '@apollo/client';

export const GET_TASKS = gql`
  query GetTasks {
    tasks {
      id
      title
      completed
    }
  }
`;
```

## Correct Hook Example

```typescript
// src/application/hooks/use-get-tasks.ts
import { gql } from '@apollo/client';
import { useQuery } from '@apollo/client/react';
import { Task } from '../../domain/entities/task';

export const GET_TASKS = gql`
  query GetTasks {
    tasks {
      id
      title
      completed
    }
  }
`;

export function useGetTasks(options?: Parameters<typeof useQuery>[1]) {
  const { data, loading, error, refetch } = useQuery<{ tasks: Task[] }>(
    GET_TASKS,
    options,
  );

  return {
    data: data?.tasks,
    isLoading: loading,
    isError: !!error,
    error,
    refetch,
  };
}
```

## Example with Use Case (when there is business logic)

```typescript
// src/application/hooks/use-get-tasks.ts
import { gql } from '@apollo/client';
import { useQuery } from '@apollo/client/react';
import { Task } from '../../domain/entities/task';
import { GetTasks } from '../use-cases/get-tasks-use-case';
import { TaskRepositoryImpl } from '../../infrastructure/repositories/task-repository-impl';

export const GET_TASKS = gql`
  query GetTasks {
    tasks {
      id
      title
      completed
    }
  }
`;

const getTasksUseCase = new GetTasks(new TaskRepositoryImpl());

export function useGetTasks(options?: Parameters<typeof useQuery>[1]) {
  const { data, loading, error, refetch } = useQuery<{ tasks: Task[] }>(
    GET_TASKS,
    {
      ...options,
      onCompleted: (data) => {
        // If you need to process data through the use case
        getTasksUseCase.execute();
        options?.onCompleted?.(data);
      },
    },
  );

  return {
    data: data?.tasks,
    isLoading: loading,
    isError: !!error,
    error,
    refetch,
  };
}
```

## Checklist for Creating a New Feature

- [ ] Entity in `domain/entities/`
- [ ] Repository interface in `domain/repositories/` (if needed)
- [ ] Use case in `application/use-cases/` (if there is business logic)
- [ ] Hook in `application/hooks/` using Apollo Client
- [ ] GraphQL query defined in the hook or in a separate file
- [ ] Repository implementation in `infrastructure/repositories/` (if using use case)
- [ ] Component in `presentation/components/` using hook

## IMPORTANT

- ALWAYS use Apollo Client in hooks (`@apollo/client/react`)
- ALWAYS normalize Apollo data to domain entities
- ALWAYS return standard format: `{ data, isLoading, isError, error, refetch }`
- Use use cases when there is complex business logic
- ALWAYS follow the flow: Component → Hook → (Use Case → Repository) → Apollo Client
