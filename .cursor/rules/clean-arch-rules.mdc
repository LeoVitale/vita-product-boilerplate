---
alwaysApply: true
---

# Clean Architecture Rules - Vita Product Boilerplate

This workspace follows Clean Architecture with SOLID principles and Apollo Client.

## Layer Structure

```
packages/
├── domain/              # Domain entities + repository interfaces (contracts)
├── application/         # Use cases + Apollo Client hooks (orchestration)
├── graphql/             # Generated GraphQL documents/types (shared)
└── ui/                  # Shared UI primitives (optional)

apps/
├── web/                 # Presentation (Next.js) + web-only infrastructure wiring
└── mobile/              # Presentation (Expo) + mobile-only infrastructure wiring
```

## Rules by Layer

### Domain Layer (`@repo/domain`)

- ✅ Define TypeScript interfaces for entities
- ✅ Declare repository interfaces (abstract contracts)
- ❌ FORBIDDEN: Implementations, frameworks, Apollo Client, business logic

### Application Layer (`@repo/application`)

#### Use Cases (`use-cases/`)

- ✅ Implement use case interfaces
- ✅ Orchestrate repository calls
- ✅ Transform data between layers when necessary
- ❌ FORBIDDEN: React components, Apollo hooks directly

#### Hooks (`hooks/`)

- ✅ Use `useQuery` and `useMutation` from `@apollo/client/react`
- ✅ Use GraphQL documents from `@repo/graphql` (generated) or define queries using `gql` when needed
- ✅ Return standard format: `{ data, isLoading, isError, error, refetch }`
- ✅ Normalize Apollo data to domain entities
- ❌ FORBIDDEN: Complex business logic (should go to use cases)

### Infrastructure Layer (per-app wiring)

- ✅ Configure Apollo Client (web/mobile specific endpoints, auth links, cache policies)
- ✅ Provide app composition/wiring (Providers, environment variables)
- ❌ FORBIDDEN: Business logic (belongs in `@repo/application` use cases)
- ❌ FORBIDDEN: Domain entity definitions (belongs in `@repo/domain`)

### Presentation Layer (apps)

- ✅ React components
- ✅ Use hooks from `@repo/application`
- ✅ Import domain types from `@repo/domain` (for typing only)
- ❌ FORBIDDEN: Define GraphQL queries/mutations
- ❌ FORBIDDEN: Call repositories/use cases directly (components should call hooks)

## Dependency Flow

```
apps (presentation) → @repo/application → @repo/domain
apps (infrastructure wiring) ──configures──> Apollo Client
```

- `@repo/domain` does not import from any other layer
- `@repo/application` imports from `@repo/domain` (and `@repo/graphql` for documents/types)
- Apps import from `@repo/application` and `@repo/domain` (types) only

## Conventions

### Naming

- Entities: PascalCase singular (`Task`, `User`)
- Repository Interfaces: `{Entity}RepositoryInterface`
- Implementations: `{Entity}RepositoryImpl`
- Use Cases: Infinitive verbs (`GetTasks`, `CreateTask`)
- Use Case Interfaces: `I` prefix (`IGetTasks`)
- Hooks: `use{Action}{Entity}` (`useGetTasks`)
- GraphQL Queries: `GET_{ENTITY}` or `{ACTION}_{ENTITY}` (`GET_TASKS`, `CREATE_TASK`)

### GraphQL Query Structure

Centralize queries in `@repo/graphql` (generated from `packages/graphql/src/**/*.graphql`).
If a query is app-specific, it should still live in `@repo/application` (hook file), not in an app component.

```typescript
import { gql } from '@apollo/client';

export const GET_TASKS = gql`
  query GetTasks {
    tasks {
      id
      title
      completed
    }
  }
`;
```

## Correct Hook Example

```typescript
// packages/application/src/hooks/use-get-tasks.ts
import { useQuery } from '@apollo/client/react';
import { GetTasksDocument } from '@repo/graphql';
import type { Task } from '@repo/domain';

export function useGetTasks(options?: Parameters<typeof useQuery>[1]) {
  const { data, loading, error, refetch } = useQuery(GetTasksDocument, options);

  return {
    data: data?.tasks?.map((t) => ({ id: t.id, title: t.title, completed: t.completed })) as
      | Task[]
      | undefined,
    isLoading: loading,
    isError: !!error,
    error,
    refetch,
  };
}
```

## Example with Use Case (when there is business logic)

```typescript
// packages/application/src/hooks/use-get-tasks.ts
// - hook talks to Apollo
// - use case holds business rules (filtering, validation, orchestration, etc.)
//
// Pattern:
// const useCase = new SomeUseCase(/* dependencies */);
// const result = useCase.execute(/* inputs */);
```

## Checklist for Creating a New Feature

- [ ] Entity in `packages/domain/src/entities/`
- [ ] Repository interface in `packages/domain/src/repositories/` (if needed)
- [ ] Use case in `packages/application/src/use-cases/` (if there is business logic)
- [ ] Hook in `packages/application/src/hooks/` using Apollo Client
- [ ] GraphQL document in `packages/graphql/src/**/*.graphql` (shared) or inside the hook (if app-specific)
- [ ] Component/screen in `apps/web` or `apps/mobile` consuming the hook

## IMPORTANT

- ALWAYS use Apollo Client in hooks (`@apollo/client/react`)
- ALWAYS normalize Apollo data to domain entities
- ALWAYS return standard format: `{ data, isLoading, isError, error, refetch }`
- Use use cases when there is complex business logic
- ALWAYS follow the flow: Component → Hook → (Use Case → Repository) → Apollo Client
