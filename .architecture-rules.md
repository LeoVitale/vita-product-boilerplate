# Advanced Clean Architecture Rules - Vita Product Boilerplate

> **Last Updated:** 2025-12-22
>
> This document defines the professional architecture standards for this monorepo.

## üìã Table of Contents

1. [Core Philosophy](#core-principles)
2. [Layer Structure](#layer-structure)
3. [Professional Patterns](#professional-patterns)
4. [Dependency Flow](#dependency-flow)
5. [Implementation Checklist](#implementation-checklist)

---

## üéØ Core Principles

- **Framework Agnostic Core**: The Domain and Application layers are pure TypeScript.
- **Dependency Inversion**: Outer layers (Infrastructure) implement interfaces defined in inner layers (Domain).
- **Explicit Error Handling**: We use the Result Pattern instead of throwing exceptions for business logic.
- **Single Source of Truth**: Entities and business rules are centralized in shared packages.

---

## üìÅ Layer Structure

### 1. Domain Layer (`@repo/domain`)

**The heart of the system. 100% Pure TypeScript.**

- **Entities**: Defined using **Zod** for schema validation and type safety.
- **Repository Interfaces**: Abstract contracts for data persistence.
- **Functional Patterns**: Contains the `Result` type for error handling.
- ‚ùå **FORBIDDEN**: Apollo Client, React, Infrastructure details, or external libraries (except Zod).

### 2. Application Layer (`@repo/application`)

**Business rule orchestration. Framework agnostic.**

- **Use Cases**: Pure classes that implement business logic and coordinate repositories.
- **Shared Hooks**: Orchestrate Use Cases and state management for both Web and Mobile.
- ‚úÖ **ALLOWED**: React Hooks (shared), but no UI logic.
- ‚ùå **FORBIDDEN**: GraphQL queries (belongs in infrastructure/graphql), UI components.

### 3. Infrastructure Layer (`@repo/infrastructure`)

**Technical implementations and external world adapters.**

- **Repositories**: Concrete implementations of Domain interfaces (e.g., `ApolloTaskRepository`).
- **Mappers**: Transform external API data (GraphQL) into Domain Entities using Zod.
- ‚úÖ **ALLOWED**: Apollo Client, Axios, Device Storage, specific libraries.

### 4. Presentation Layer (Apps)

**The thin "Imperative Shell".**

- **Web (Next.js)** & **Mobile (Expo)**.
- **Composition Root**: Instantiate repositories and use cases here.
- **UI Components**: Render screens based on shared application hooks.
- ‚ùå **FORBIDDEN**: GraphQL queries, business logic, direct repository access.

---

## üöÄ Professional Patterns

### Zod as Source of Truth

We define our domain schemas once and infer types from them.

```typescript
// @repo/domain
export const TaskSchema = z.object({
  id: z.string(),
  title: z.string().min(3),
  completed: z.boolean(),
});
export type Task = z.infer<typeof TaskSchema>;
```

### Functional Result Pattern

Avoid `try/catch` for expected business errors.

```typescript
// use-case execution
async execute(): Promise<Result<Task[]>> {
  const tasks = await this.repo.findAll();
  if (tasks.isFailure) return failure(tasks.error);
  return success(tasks.value);
}
```

### Dependency Inversion (DI)

Use Cases depend on interfaces, never on implementations.

```typescript
// Application Layer
export class GetTasksUseCase {
  constructor(private taskRepo: TaskRepositoryInterface) {} // Pure interface
}

// Infrastructure Layer
export class ApolloTaskRepository implements TaskRepositoryInterface { ... }
```

---

## üîÑ Dependency Flow

```mermaid
graph LR
    Apps[Apps / Presentation] --> AppPkg[@repo/application]
    Apps --> InfraPkg[@repo/infrastructure]
    AppPkg --> DomainPkg[@repo/domain]
    InfraPkg --> DomainPkg
    AppPkg --> InfraPkg
```

1.  **Apps** are responsible for wiring everything together (**Composition Root**).
2.  **Application** depends on **Domain** interfaces.
3.  **Infrastructure** implements **Domain** interfaces.

---

## ‚úÖ Implementation Checklist

- [ ] Define **Zod Schema** in `@repo/domain/entities`.
- [ ] Declare **Repository Interface** in `@repo/domain/repositories`.
- [ ] Create **Use Case** in `@repo/application/use-cases`.
- [ ] Implement **Shared Hook** in `@repo/application/hooks`.
- [ ] Implement **Repository** in `@repo/infrastructure/repositories`.
- [ ] Instantiate and inject dependencies in the **App** (web/mobile).

---

## üìö References

- [Clean Architecture (Uncle Bob)](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)
- [Functional Programming in TypeScript](https://github.com/gcanti/fp-ts)
