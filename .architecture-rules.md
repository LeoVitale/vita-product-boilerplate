# Clean Architecture Rules - Vita Product Boilerplate

> **Ãšltima atualizaÃ§Ã£o:** 2025-01-27
>
> Este documento define as regras de Clean Architecture para este workspace. Atualize este arquivo quando houver mudanÃ§as na arquitetura ou novas convenÃ§Ãµes.
>
> **Nota:** Este projeto usa Apollo Client para gerenciamento de estado e cache GraphQL.

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Estrutura de Camadas](#estrutura-de-camadas)
3. [Regras por Camada](#regras-por-camada)
4. [Fluxo de DependÃªncias](#fluxo-de-dependÃªncias)
5. [ConvenÃ§Ãµes de CÃ³digo](#convenÃ§Ãµes-de-cÃ³digo)
6. [Exemplos PrÃ¡ticos](#exemplos-prÃ¡ticos)
7. [Checklist de ImplementaÃ§Ã£o](#checklist-de-implementaÃ§Ã£o)

---

## ğŸ¯ VisÃ£o Geral

Este projeto segue **Clean Architecture** com **SOLID principles** e utiliza **Apollo Client** como camada de gerenciamento de estado e cache GraphQL.

### PrincÃ­pios Fundamentais

- **Dependency Inversion**: Camadas internas nÃ£o dependem de camadas externas
- **Separation of Concerns**: Cada camada tem uma responsabilidade Ãºnica
- **Testability**: Cada camada pode ser testada independentemente
- **Maintainability**: MudanÃ§as em uma camada nÃ£o afetam outras

---

## ğŸ“ Estrutura de Camadas

```
apps/web/src/
â”œâ”€â”€ domain/                    # Camada de DomÃ­nio (Mais Interna)
â”‚   â”œâ”€â”€ entities/             # Entidades de negÃ³cio
â”‚   â””â”€â”€ repositories/        # Interfaces de repositÃ³rio
â”‚
â”œâ”€â”€ application/              # Camada de AplicaÃ§Ã£o
â”‚   â”œâ”€â”€ use-cases/           # Casos de uso (orquestraÃ§Ã£o)
â”‚   â””â”€â”€ hooks/               # Apollo Client hooks
â”‚
â”œâ”€â”€ infrastructure/           # Camada de Infraestrutura
â”‚   â”œâ”€â”€ graphql/            # Cliente GraphQL (Apollo)
â”‚   â””â”€â”€ repositories/       # ImplementaÃ§Ãµes de repositÃ³rio
â”‚
â””â”€â”€ presentation/            # Camada de ApresentaÃ§Ã£o
    â””â”€â”€ components/          # Componentes React
```

---

## ğŸ—ï¸ Regras por Camada

### 1. Domain Layer (`src/domain`)

**Responsabilidade:** Definir entidades de negÃ³cio e contratos de repositÃ³rio.

#### âœ… PERMITIDO:

- Definir interfaces TypeScript para entidades
- Declarar interfaces de repositÃ³rio (contratos abstratos)
- Tipos e enums relacionados ao domÃ­nio

#### âŒ PROIBIDO:

- ImplementaÃ§Ãµes concretas
- LÃ³gica de negÃ³cio complexa (vai para use cases)
- DependÃªncias de frameworks (React, Apollo, etc.)
- Apollo Client ou qualquer biblioteca de estado

#### Exemplo:

```typescript
// âœ… CORRETO: src/domain/entities/task.ts
export interface Task {
  id: string;
  title: string;
  completed: boolean;
}

// âœ… CORRETO: src/domain/repositories/task-repository-interface.ts
import { Task } from '../entities/task';

export interface TaskRepositoryInterface {
  list(): Promise<Task[]>;
  getById(id: string): Promise<Task>;
  create(task: Omit<Task, 'id'>): Promise<Task>;
  update(task: Task): Promise<Task>;
  delete(id: string): Promise<void>;
}
```

---

### 2. Application Layer (`src/application`)

**Responsabilidade:** Orquestrar casos de uso e expor hooks Apollo Client.

#### 2.1 Use Cases (`src/application/use-cases`)

**Responsabilidade:** Implementar lÃ³gica de negÃ³cio usando repositÃ³rios.

#### âœ… PERMITIDO:

- Implementar interfaces de use case
- Orquestrar chamadas a repositÃ³rios
- Transformar dados entre camadas (se necessÃ¡rio)
- ValidaÃ§Ãµes de negÃ³cio

#### âŒ PROIBIDO:

- DependÃªncias diretas de HTTP clients (Axios, Apollo)
- React Query diretamente
- Componentes React
- LÃ³gica de UI

#### Exemplo:

```typescript
// âœ… CORRETO: src/application/use-cases/get-tasks-use-case.ts
import { Task } from '../../domain/entities/task';
import { TaskRepositoryInterface } from '../../domain/repositories/task-repository-interface';

export interface IGetTasks {
  execute(): Promise<Task[]>;
}

export class GetTasks implements IGetTasks {
  constructor(private repo: TaskRepositoryInterface) {}

  async execute(): Promise<Task[]> {
    return this.repo.list();
  }
}
```

#### 2.2 Hooks (`src/application/hooks`)

**Responsabilidade:** Criar hooks Apollo Client para expor queries e mutations GraphQL.

#### âœ… PERMITIDO:

- Usar `useQuery` e `useMutation` do `@apollo/client/react`
- Definir queries GraphQL usando `gql`
- Normalizar dados do Apollo para entidades do domÃ­nio
- Expor opÃ§Ãµes do Apollo Client via parÃ¢metros
- Retornar formato padrÃ£o: `{ data, isLoading, isError, error, refetch }`
- Usar use cases quando houver lÃ³gica de negÃ³cio complexa

#### âŒ PROIBIDO:

- LÃ³gica de negÃ³cio complexa no hook (deve ir para use cases)
- Componentes React
- Chamar repositÃ³rios diretamente (preferir use cases quando necessÃ¡rio)

#### Exemplo Simples (sem lÃ³gica de negÃ³cio):

```typescript
// âœ… CORRETO: src/application/hooks/use-get-tasks.ts
import { gql } from '@apollo/client';
import { useQuery } from '@apollo/client/react';
import { Task } from '../../domain/entities/task';

export const GET_TASKS = gql`
  query GetTasks {
    tasks {
      id
      title
      completed
    }
  }
`;

export function useGetTasks(options?: Parameters<typeof useQuery>[1]) {
  const { data, loading, error, refetch } = useQuery<{ tasks: Task[] }>(
    GET_TASKS,
    options,
  );

  return {
    data: data?.tasks,
    isLoading: loading,
    isError: !!error,
    error,
    refetch,
  };
}
```

#### Exemplo com Use Case (quando hÃ¡ lÃ³gica de negÃ³cio):

```typescript
// âœ… CORRETO: src/application/hooks/use-get-tasks.ts
import { gql } from '@apollo/client';
import { useQuery } from '@apollo/client/react';
import { Task } from '../../domain/entities/task';
import { GetTasks } from '../use-cases/get-tasks-use-case';
import { TaskRepositoryImpl } from '../../infrastructure/repositories/task-repository-impl';

export const GET_TASKS = gql`
  query GetTasks {
    tasks {
      id
      title
      completed
    }
  }
`;

const getTasksUseCase = new GetTasks(new TaskRepositoryImpl());

export function useGetTasks(options?: Parameters<typeof useQuery>[1]) {
  const { data, loading, error, refetch } = useQuery<{ tasks: Task[] }>(
    GET_TASKS,
    {
      ...options,
      onCompleted: (data) => {
        // Processar dados atravÃ©s do use case se necessÃ¡rio
        getTasksUseCase.execute();
        options?.onCompleted?.(data);
      },
    },
  );

  return {
    data: data?.tasks,
    isLoading: loading,
    isError: !!error,
    error,
    refetch,
  };
}
```

---

### 3. Infrastructure Layer (`src/infrastructure`)

**Responsabilidade:** Implementar contratos usando tecnologias especÃ­ficas.

#### âœ… PERMITIDO:

- Implementar interfaces de repositÃ³rio
- Configurar clientes HTTP (Apollo Client, Axios)
- Transformar dados da API para entidades do domÃ­nio
- ConfiguraÃ§Ãµes de rede e cache

#### âŒ PROIBIDO:

- Hooks Apollo diretamente (ficam na camada de aplicaÃ§Ã£o)
- Componentes React
- LÃ³gica de negÃ³cio
- DependÃªncias de use cases

#### Exemplo:

```typescript
// âœ… CORRETO: src/infrastructure/graphql/apollo-client.ts
import { ApolloClient, InMemoryCache, HttpLink } from '@apollo/client';

const endpoint =
  process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:4000/graphql';

export const apolloClient = new ApolloClient({
  link: new HttpLink({ uri: endpoint }),
  cache: new InMemoryCache(),
});

// âœ… CORRETO: src/infrastructure/repositories/task-repository-impl.ts
import { gql } from '@apollo/client';
import { TaskRepositoryInterface } from '../../domain/repositories/task-repository-interface';
import { Task } from '../../domain/entities/task';
import { apolloClient } from '../graphql/apollo-client';

export class TaskRepositoryImpl implements TaskRepositoryInterface {
  async list(): Promise<Task[]> {
    const query = gql`
      query GetTasks {
        tasks {
          id
          title
          completed
        }
      }
    `;

    const { data } = await apolloClient.query<{ tasks: Task[] }>({
      query,
    });

    return data.tasks;
  }

  async getById(id: string): Promise<Task> {
    // ImplementaÃ§Ã£o...
  }

  async create(task: Omit<Task, 'id'>): Promise<Task> {
    // ImplementaÃ§Ã£o...
  }

  async update(task: Task): Promise<Task> {
    // ImplementaÃ§Ã£o...
  }

  async delete(id: string): Promise<void> {
    // ImplementaÃ§Ã£o...
  }
}
```

---

### 4. Presentation Layer (`src/presentation`)

**Responsabilidade:** Renderizar UI usando hooks da camada de aplicaÃ§Ã£o.

#### âœ… PERMITIDO:

- Componentes React
- Usar hooks da camada de aplicaÃ§Ã£o
- LÃ³gica de apresentaÃ§Ã£o (formataÃ§Ã£o, validaÃ§Ã£o de formulÃ¡rios)
- Estados locais de UI (modais, dropdowns, etc.)

#### âŒ PROIBIDO:

- Chamar repositÃ³rios diretamente
- Chamar use cases diretamente
- LÃ³gica de negÃ³cio
- ConfiguraÃ§Ãµes de API

#### Exemplo:

```typescript
// âœ… CORRETO: src/presentation/components/task-list.tsx
'use client';

import { useGetTasks } from '../../application/hooks/use-get-tasks';

export function TaskList() {
  const { data: tasks, isLoading, isError, error } = useGetTasks();

  if (isLoading) return <div>Loading...</div>;
  if (isError) return <div>Error: {error?.message}</div>;

  return (
    <ul>
      {tasks?.map((task) => (
        <li key={task.id}>
          {task.title} - {task.completed ? 'Done' : 'Pending'}
        </li>
      ))}
    </ul>
  );
}
```

---

## ğŸ”„ Fluxo de DependÃªncias

### DireÃ§Ã£o das DependÃªncias (Sempre de fora para dentro)

```
Presentation â†’ Application â†’ Domain â† Infrastructure
     â†“              â†“           â†‘            â†‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Regras de ImportaÃ§Ã£o

1. **Domain** nÃ£o importa de nenhuma outra camada
2. **Application** importa apenas de **Domain**
3. **Infrastructure** importa apenas de **Domain**
4. **Presentation** importa apenas de **Application** e **Domain** (para tipos)

### Exemplo de Fluxo Completo

```
1. Component (Presentation)
   â†“ usa hook
2. useGetTasks (Application/Hooks)
   â†“ usa use case
3. GetTasks (Application/UseCases)
   â†“ usa interface
4. TaskRepositoryInterface (Domain)
   â†‘ implementado por
5. TaskRepositoryImpl (Infrastructure)
   â†“ usa
6. Apollo Client (Infrastructure)
```

---

## ğŸ“ ConvenÃ§Ãµes de CÃ³digo

### Nomenclatura

- **Entidades**: PascalCase singular (`Task`, `User`)
- **Interfaces de RepositÃ³rio**: `{Entity}RepositoryInterface` (`TaskRepositoryInterface`)
- **ImplementaÃ§Ãµes de RepositÃ³rio**: `{Entity}RepositoryImpl` (`TaskRepositoryImpl`)
- **Use Cases**: Verbos no infinitivo (`GetTasks`, `CreateTask`, `UpdateTask`)
- **Interfaces de Use Case**: Prefixo `I` (`IGetTasks`, `ICreateTask`)
- **Hooks**: `use{Action}{Entity}` (`useGetTasks`, `useCreateTask`)
- **Queries GraphQL**: `GET_{ENTITY}` ou `{ACTION}_{ENTITY}` (`GET_TASKS`, `CREATE_TASK`)

### Queries GraphQL

Centralize queries GraphQL em arquivos de hooks ou em `src/application/graphql/queries.ts`:

```typescript
// src/application/hooks/use-get-tasks.ts ou src/application/graphql/queries.ts
import { gql } from '@apollo/client';

export const GET_TASKS = gql`
  query GetTasks {
    tasks {
      id
      title
      completed
    }
  }
`;

export const GET_TASK = gql`
  query GetTask($id: ID!) {
    task(id: $id) {
      id
      title
      completed
    }
  }
`;
```

### Estrutura de Arquivos

```
src/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ {entity-name}.ts
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ {entity-name}-repository-interface.ts
â”‚
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ use-cases/
â”‚   â”‚   â””â”€â”€ {action}-{entity}-use-case.ts
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ use-{action}-{entity}.ts
â”‚   â””â”€â”€ graphql/ (opcional)
â”‚       â””â”€â”€ queries.ts
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ graphql/
â”‚   â”‚   â””â”€â”€ apollo-client.ts
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ {entity-name}-repository-impl.ts
â”‚
â””â”€â”€ presentation/
    â””â”€â”€ components/
        â””â”€â”€ {component-name}.tsx
```

---

## ğŸ’¡ Exemplos PrÃ¡ticos

### Exemplo Completo: Criar uma Nova Feature

#### 1. Definir Entidade (Domain)

```typescript
// src/domain/entities/user.ts
export interface User {
  id: string;
  name: string;
  email: string;
}
```

#### 2. Definir Interface de RepositÃ³rio (Domain)

```typescript
// src/domain/repositories/user-repository-interface.ts
import { User } from '../entities/user';

export interface UserRepositoryInterface {
  getById(id: string): Promise<User>;
  list(): Promise<User[]>;
}
```

#### 3. Criar Use Case (Application)

```typescript
// src/application/use-cases/get-user-use-case.ts
import { User } from '../../domain/entities/user';
import { UserRepositoryInterface } from '../../domain/repositories/user-repository-interface';

export interface IGetUser {
  execute(id: string): Promise<User>;
}

export class GetUser implements IGetUser {
  constructor(private repo: UserRepositoryInterface) {}

  async execute(id: string): Promise<User> {
    return this.repo.getById(id);
  }
}
```

#### 4. Implementar RepositÃ³rio (Infrastructure)

```typescript
// src/infrastructure/repositories/user-repository-impl.ts
import { gql } from '@apollo/client';
import { UserRepositoryInterface } from '../../domain/repositories/user-repository-interface';
import { User } from '../../domain/entities/user';
import { apolloClient } from '../graphql/apollo-client';

export class UserRepositoryImpl implements UserRepositoryInterface {
  async getById(id: string): Promise<User> {
    const query = gql`
      query GetUser($id: ID!) {
        user(id: $id) {
          id
          name
          email
        }
      }
    `;

    const { data } = await apolloClient.query<{ user: User }>({
      query,
      variables: { id },
    });

    return data.user;
  }

  async list(): Promise<User[]> {
    // ImplementaÃ§Ã£o...
  }
}
```

#### 5. Criar Hook (Application)

```typescript
// src/application/hooks/use-get-user.ts
import { gql } from '@apollo/client';
import { useQuery } from '@apollo/client/react';
import { User } from '../../domain/entities/user';

export const GET_USER = gql`
  query GetUser($id: ID!) {
    user(id: $id) {
      id
      name
      email
    }
  }
`;

export function useGetUser(
  id: string,
  options?: Parameters<typeof useQuery>[1],
) {
  const { data, loading, error, refetch } = useQuery<{ user: User }>(GET_USER, {
    variables: { id },
    skip: !id, // SÃ³ executa se id existir
    ...options,
  });

  return {
    data: data?.user,
    isLoading: loading,
    isError: !!error,
    error,
    refetch,
  };
}
```

#### 6. Usar no Componente (Presentation)

```typescript
// src/presentation/components/user-profile.tsx
'use client';

import { useGetUser } from '../../application/hooks/use-get-user';

export function UserProfile({ userId }: { userId: string }) {
  const { data: user, isLoading, isError } = useGetUser(userId);

  if (isLoading) return <div>Loading user...</div>;
  if (isError) return <div>Error loading user</div>;

  return (
    <div>
      <h2>{user?.name}</h2>
      <p>{user?.email}</p>
    </div>
  );
}
```

---

## âœ… Checklist de ImplementaÃ§Ã£o

Ao criar uma nova feature, verifique:

### Domain

- [ ] Entidade criada em `domain/entities/`
- [ ] Interface de repositÃ³rio criada em `domain/repositories/`
- [ ] Nenhuma dependÃªncia de outras camadas

### Application

- [ ] Use case criado em `application/use-cases/` (se necessÃ¡rio)
- [ ] Interface do use case definida (se usar use case)
- [ ] Hook criado em `application/hooks/`
- [ ] Hook usa Apollo Client (`@apollo/client/react`)
- [ ] Query GraphQL definida no hook ou arquivo separado
- [ ] Hook normaliza dados para entidades do domÃ­nio
- [ ] Hook retorna formato padrÃ£o: `{ data, isLoading, isError, error, refetch }`

### Infrastructure

- [ ] ImplementaÃ§Ã£o do repositÃ³rio em `infrastructure/repositories/`
- [ ] ImplementaÃ§Ã£o usa Apollo Client (ou outro cliente HTTP)
- [ ] Nenhuma dependÃªncia de Application ou Presentation

### Presentation

- [ ] Componente criado em `presentation/components/`
- [ ] Componente usa hook da Application
- [ ] Nenhuma chamada direta a repositÃ³rio ou use case

### Testes

- [ ] Entidade testÃ¡vel isoladamente
- [ ] Use case testÃ¡vel com mock de repositÃ³rio
- [ ] Hook testÃ¡vel com mock de use case
- [ ] Componente testÃ¡vel com mock de hook

---

## ğŸ”„ AtualizaÃ§Ãµes Futuras

### Como Atualizar Este Documento

1. **Adicionar novas regras**: Inclua na seÃ§Ã£o apropriada
2. **Modificar regras existentes**: Atualize a seÃ§Ã£o e a data de atualizaÃ§Ã£o
3. **Adicionar exemplos**: Inclua na seÃ§Ã£o "Exemplos PrÃ¡ticos"
4. **Documentar decisÃµes**: Adicione seÃ§Ã£o "DecisÃµes de Arquitetura" se necessÃ¡rio

### Template para Novas Regras

```markdown
### [Nome da Nova Regra]

**Data de AdiÃ§Ã£o:** YYYY-MM-DD
**Motivo:** [Por que esta regra foi adicionada]

#### Regra:

[DescriÃ§Ã£o da regra]

#### Exemplo:

[Exemplo de cÃ³digo]
```

---

## ğŸ“š ReferÃªncias

- [Clean Architecture by Robert C. Martin](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)
- [Apollo Client Documentation](https://www.apollographql.com/docs/react/)
- [GraphQL Documentation](https://graphql.org/)

---

**Ãšltima RevisÃ£o:** 2025-01-27
**PrÃ³xima RevisÃ£o:** [Definir quando necessÃ¡rio]
